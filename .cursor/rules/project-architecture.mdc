---
alwaysApply: true
---
# Arquitectura del Proyecto EmojiKeyboardTest

## Resumen General

Este proyecto es una **biblioteca de teclado de emojis para Android** (`EmojiKeyboard`) junto con una **aplicación de demostración** (`app`) para probarla. La biblioteca permite integrar un teclado de emojis personalizado que se muestra como un popup que coexiste con el teclado del sistema. El funcionamiento del popup busca imitar el del teclado del sistema.

## Estructura de Módulos

```
EmojiKeyboardTest/
├── app/                    # Aplicación de demostración (chat simple)
├── EmojiKeyboard/          # Biblioteca de teclado de emojis (publicable)
├── gradle/                 # Configuración de Gradle
└── settings.gradle.kts     # Define los módulos: :app y :EmojiKeyboard
```

## Módulo EmojiKeyboard (Biblioteca)

### Dependencias Principales
- `kotlinx.serialization` - Parsing de JSON para datos de emojis
- Maven Publish plugin - Para publicar como AAR

### Arquitectura por Capas

```
EmojiKeyboard/src/main/java/com/davidperi/emojikeyboard/
├── EmojiManager.kt         # ⭐ SINGLETON DE INSTALACIÓN (patrón INSTALLER)
├── EmojiPopup.kt           # Punto de entrada para el popup
├── EmojiKeyboardConfig.kt  # EmojiConfig - Configuración del teclado
├── data/                   # Capa de datos
│   ├── EmojiIndex.kt       # Índice HashSet para detección O(1) de emojis
│   ├── model/              # Modelos de dominio
│   ├── prefs/              # Persistencia (SharedPreferences)
│   └── provider/           # Proveedores de emojis
├── logic/                  # Lógica de negocio
├── text/                   # Componentes de texto personalizados
├── ui/                     # Capa de presentación
│   ├── adapter/            # RecyclerView adapters
│   ├── anim/               # Animaciones y transiciones
│   ├── span/               # Spans para tipografía de emojis
│   ├── state/              # Máquina de estados del popup
│   └── view/               # Vistas y componentes UI
└── utils/                  # Utilidades
```

---

## Clases Principales

### 1. EmojiManager (Singleton de Instalación)

**Archivo:** `EmojiManager.kt`

Es el **singleton central** que debe inicializarse en `Application.onCreate()`. Gestiona:
- Instalación y configuración global de la biblioteca
- Precarga de emojis al inicio
- Tipografía compartida entre componentes
- Acceso centralizado a gestores (recientes, preferencias)

**API Pública:**
```kotlin
object EmojiManager {
    fun install(context: Context, config: EmojiConfig = EmojiConfig())
    fun isInstalled(): Boolean
    fun getConfig(): EmojiConfig
    fun getTypeface(): Typeface
    fun getLayoutMode(): EmojiLayoutMode
    fun getCategories(): List<Category>
    suspend fun getCategoriesAsync(): List<Category>
    fun getEmojiIndex(): EmojiIndex       // Índice para detección de emojis O(1)
    fun getRecentManager(): RecentEmojiManager
    fun getPrefsManager(): PrefsManager
}
```

### 2. EmojiPopup (Vista del Popup)

**Archivo:** `EmojiPopup.kt`

Es la **API pública** para mostrar el teclado de emojis. Gestiona:
- El contenedor del popup (FrameLayout)
- La interacción con WindowInsets del teclado del sistema
- El ciclo de vida del popup

**API Pública:**
```kotlin
val state: PopupState                           // Estado actual
fun bindTo(editText: EditText)                  // Vincula a un EditText
fun toggle()                                    // Alterna mostrar/ocultar
fun hide()                                      // Oculta el popup
fun setOnPopupStateChangedListener(...)         // Callback de cambio de estado
fun setAnimationCallback(...)                   // Callback de animaciones
fun setOnPopupSizeChangeListener(...)           // Callback de cambio de tamaño
```

### 3. PopupStateMachine

**Archivo:** `ui/state/PopupStateMachine.kt`

Implementa una **máquina de estados finita** que controla las transiciones del popup.

**Estados (PopupState):**
- `COLLAPSED` - Popup completamente cerrado
- `BEHIND` - Popup oculto detrás del teclado del sistema (IME visible)
- `FOCUSED` - Popup visible, teclado del sistema oculto
- `SEARCHING` - Popup en modo búsqueda con IME visible

**Eventos:**
- `toggle()` - Alternar estado
- `hide()` - Ocultar
- `search()` - Entrar en modo búsqueda
- `write()` - Escribir en el EditText
- `imeUp()` / `imeDown()` - Reacciones al teclado del sistema

**Diagrama de Transiciones:**
```
COLLAPSED ←→ FOCUSED ←→ SEARCHING
     ↓↑          ↓↑
   BEHIND ←------↑
```

### 4. EmojiKeyboardView

**Archivo:** `ui/view/EmojiKeyboardView.kt`

Vista principal del teclado que contiene todos los componentes UI. Implementa `EmojiDelegate` para coordinar eventos entre componentes. Obtiene configuración y recursos desde `EmojiManager`.

**Componentes internos:**
- `CategoryBar` - Barra de categorías de emojis
- `Backspace` - Botón de borrado
- `SearchBar` - Barra de búsqueda
- `SearchResults` - Resultados de búsqueda
- `EmojiGrid` - Grid principal de emojis

**Modos de Layout (`EmojiLayoutMode`):**
- `ROBOT` - Grid vertical (9 columnas), barra de categorías arriba
- `COOPER` - Grid horizontal (4 filas), barra de categorías abajo

### 5. EmojiDelegate (Interface)

**Archivo:** `ui/view/EmojiDelegate.kt`

Interface que define la comunicación entre componentes UI:
```kotlin
interface EmojiDelegate {
    fun onCategorySelected(index: Int, progress: Float)
    fun onEmojiClicked(unicode: String)
    fun onGridScrolled(position: Int)
    fun onQueryChanged(query: String)
    fun onSearchFocusChange(hasFocus: Boolean)
    fun onBackspacePressed()
}
```

---

## Capa de Datos

### Modelos

**Category:**
```kotlin
data class Category(
    val id: String,
    val name: String,
    @DrawableRes val icon: Int,
    val emojis: List<Emoji>
)
```

**Emoji:**
```kotlin
data class Emoji(
    val unicode: String,
    val description: String,
    val keywords: List<String>,
    val variants: List<Emoji>  // Variantes de tono de piel, etc.
)
```

### EmojiIndex (Detección de Emojis)

**Archivo:** `data/EmojiIndex.kt`

Índice basado en `HashSet` que permite detectar emojis soportados en O(1):
- Se construye automáticamente durante `EmojiManager.install()` a partir de las categorías del provider
- Incluye todos los emojis y sus variantes (~3500 entradas)
- Usado por `EmojiUtils` para detección precisa (solo detecta emojis que el provider soporta)

```kotlin
class EmojiIndex {
    fun contains(unicode: String): Boolean  // O(1) lookup
    val size: Int
    companion object {
        fun build(categories: List<Category>): EmojiIndex
    }
}
```

### Proveedores de Emojis

**EmojiProvider (Interface):**
```kotlin
interface EmojiProvider {
    suspend fun getCategories(context: Context): List<Category>
}
```

**AssetEmojiProvider (Implementación por defecto):**
- Carga emojis desde `assets/providers/emojis_en.json`
- Usa `kotlinx.serialization` para el parsing
- Cache en memoria para evitar recargas

### Persistencia

**PrefsManager:**
- Guarda la altura del teclado detectada (`lastKeyboardHeight`)
- Accesible via `EmojiManager.getPrefsManager()`

**RecentEmojiManager:**
- Gestiona la lista de emojis usados recientemente
- Límite configurable de emojis guardados
- Accesible via `EmojiManager.getRecentManager()`

---

## Sistema de Animaciones

### Archivos clave:
- `PopupAnimator.kt` - Anima la apertura/cierre del popup
- `ImeAnimator.kt` - Sincroniza animaciones con el teclado del sistema
- `EmojiWindowAnimationCallback.kt` - Interface para callbacks de animación

### Integración con WindowInsets:
El sistema intercepta los WindowInsets del teclado del sistema para:
1. Detectar cuándo el IME sube/baja
2. Sincronizar la altura del popup
3. Ajustar los insets para la vista raíz

---

## Configuración

**EmojiConfig:** (archivo `EmojiKeyboardConfig.kt`)
```kotlin
data class EmojiConfig(
    val provider: EmojiProvider = AssetEmojiProvider,  // Fuente de emojis
    val font: Typeface? = null,                        // Fuente personalizada
    val layoutMode: EmojiLayoutMode = COOPER           // Modo de layout
)
```

La configuración se pasa a `EmojiManager.install()` y es accesible globalmente via `EmojiManager.getConfig()`.

---

## Módulo App (Demostración)

### Estructura:
```
app/src/main/java/com/davidperi/emojikeyboardtest/
├── EmojiKeyboardTestApp.kt   # Application - Instala EmojiManager
├── MainActivity.kt           # Activity principal con chat
├── adapter/ChatAdapter.kt    # Adapter del RecyclerView de chat
├── model/ChatMessage.kt      # Modelo de mensaje
└── utils/MeasureUtils.kt     # Utilidades de medición
```

### Instalación en Application:
```kotlin
class EmojiKeyboardTestApp : Application() {
    override fun onCreate() {
        super.onCreate()
        EmojiManager.install(
            context = this,
            config = EmojiConfig(
                layoutMode = EmojiLayoutMode.COOPER
            )
        )
    }
}
```

### Uso típico en MainActivity:
```kotlin
// 1. Crear el popup (EmojiManager ya está instalado)
emojiPopup = EmojiPopup(this)

// 2. Vincular a un EditText
emojiPopup.bindTo(binding.etTest)

// 3. Configurar animaciones
binding.root.setupKeyboardAnimation(viewList)
binding.root.setupEmojiPopupAnimation(emojiPopup, viewList)

// 4. Toggle con un botón
binding.ivToggleEmojiKeyboard.setOnClickListener {
    emojiPopup.toggle()
}

// 5. Manejar el botón atrás
if (emojiPopup.state == PopupState.FOCUSED) {
    emojiPopup.hide()
}
```

---

## Flujo de Datos Principal

```
1. Application.onCreate() → EmojiManager.install()
2. EmojiManager precarga categorías via EmojiProvider
3. EmojiManager construye EmojiIndex (HashSet de unicodes soportados)
4. EmojiKeyboardView obtiene datos de EmojiManager
5. EmojiListMapper transforma → List<EmojiListItem>
6. EmojiAdapter/ViewHolders renderizan el grid
7. Usuario toca emoji → EmojiDelegate.onEmojiClicked()
8. EmojiKeyboardView inserta en EditText con TypefaceSpan
9. EmojiUtils detecta emojis via EmojiIndex (O(1) por graphema)
10. EmojiManager.getRecentManager() guarda el emoji usado
```

---

## Recursos Importantes

### Assets:
- `assets/providers/emojis_en.json` - Base de datos de emojis
- `assets/fonts/Cooper.ttf` - Fuente de emojis por defecto

### Namespace:
- Biblioteca: `com.davidperi.emojikeyboard`
- App: `com.davidperi.emojikeyboardtest`

### Versiones:
- minSdk: 24
- targetSdk/compileSdk: 36
- JVM Target: 17

---

## Notas de Implementación

1. **Patrón INSTALLER**: La biblioteca usa un singleton `EmojiManager` que debe instalarse en `Application.onCreate()` antes de usar cualquier componente. Esto permite precarga de datos y acceso global a recursos.

2. **El popup se añade lazy**: Solo se añade al rootView la primera vez que se llama `toggle()`

3. **Altura del teclado**: Se detecta automáticamente del IME del sistema y se guarda en SharedPreferences para futuras sesiones. El popup altera el inset de tipo ime para que quien lo implemente lo perciba como un teclado del sistema.

4. **ViewBinding**: Ambos módulos usan ViewBinding (`buildFeatures { viewBinding = true }`)

5. **Coroutines**: Se usan para cargas asíncronas de datos y debounce en la búsqueda

6. **Publicación Maven**: El módulo EmojiKeyboard está configurado para publicarse como AAR con `maven-publish`

7. **Acceso centralizado**: Todos los componentes (EmojiPopup, EmojiTextView, EmojiEditText, etc.) obtienen configuración y recursos desde `EmojiManager` en lugar de crear sus propias instancias.

8. **Detección de emojis**: `EmojiUtils` usa `EmojiIndex` (HashSet) + `BreakIterator` para detectar emojis. Solo detecta emojis que están en el provider, garantizando consistencia visual con la fuente personalizada.
